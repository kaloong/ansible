---
- hosts: localhost
  gather_facts: false
  connection: local
  vars:
    vmdeployment_test: !vault |
          $ANSIBLE_VAULT;1.2;AES256;test
          34356436653061353632336366353234656438393739333030316138306437643632376365633662
          3233396437663530393939333063306139383235663438380a303539326361346636643733626638
          32343631303765366335323139616638643861666435653533616134323064316465616463623966
          3536383639306436660a343738323434636164343433386163333632636464616664616532346538
          6633
    vmdeployment_dev: !vault |
          $ANSIBLE_VAULT;1.2;AES256;dev
          63623838643261306361616230353933613964636236643031303630376363363766353666323966
          3235653937616638386535636463623839383133653734330a623730343166623933316330633236
          32613163653266636631336263313933316639353035663735306661363462333537396666623262
          3462626363613366610a303235353164386565323231653836633237333237383937636532663239
          3965
  tasks:
  - name: Create a vm
    vmware_guest:
      hostname: 172.16.21.30
      username: svc_vmdeployer@mega.lan
      password: '{{ vmdeployment_test }}'
      datacenter: mihome.lab
      validate_certs: no
      folder: /vm/
      name: test_vm_0001
      state: poweredon
      guest_id: centos7_64guest
      esxi_hostname: 172.16.21.20
      cdrom:
        type: iso
        iso_path: "[SkullDataStore] TinyCore-current.iso"
      disk:
      - size_gb: 10
        type: thin
        datastore: ESK00_SSD_1T
      hardware:
        memory_mb: 512
        num_cpus: 1
        scsi: paravirtual
      networks:
      - name: VM Network
        ip: 172.16.21.101
        netmask: 255.255.255.0
        device_type: vmxnet3
      wait_for_ip_address: True
      state: present
    delegate_to: localhost
    register: newly_deployed_vm

  - name: IP address info
    debug:
      msg: "{{ newly_deployed_vm.instance.ipv4 }} {{ name }}"
